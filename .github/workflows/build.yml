name: Build

on:
  push:
    branches:
      - master

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2.4.0
        with:
          fetch-depth: 0

      - name: Checkout helm-charts repository
        uses: actions/checkout@v2.4.0
        with:
          repository: sebczu/helm-charts
          path: helm-charts
          ref: master
          fetch-depth: 0
          token: ${{ secrets.REPO_TOKEN }}

#      - name: Configure Git
#        run: |
#          git config user.name "$GITHUB_ACTOR"
#          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Setup helm
        uses: azure/setup-helm@v1
        with:
          version: '3.7.1'

#  helm version
#  git version
#  ls -a
#  echo "IN HELM-CHARTS"
#  cd helm-charts
#  touch test.txt
#  ls -a
#  echo "lets try again"
#  git remote set-url origin https://sebczu:${{ secrets.REPO_TOKEN }}@github.com/sebczu/helm-charts.git
#  echo "hmm"
#  git config --global user.name 'sebczu'
#  git config --global user.email 'dev.sebastian.czubala@gmail.com'
#  git add .
#  git commit -m "test"
#  git push -u origin master

      - name: Create Helm package
        run: |
          helm package service/ --destination helm-charts
          cd helm-charts
          echo "HELM CHARTS"
          ls
          echo "HELM CHARTS"

      - name: Recreate Helm repository index
        run: |
          cd helm-charts
          helm repo index .

      - name: Push Helm package
        run: |
          cd helm-charts
          git remote set-url origin https://sebczu:${{ secrets.REPO_TOKEN }}@github.com/sebczu/helm-charts.git
          git config --global user.name 'sebczu'
          git config --global user.email 'dev.sebastian.czubala@gmail.com'
          git add .
          git commit -m "Helm chart push"
          git push -u origin master

